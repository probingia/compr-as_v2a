<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compr-As</title>
    <link href="libs/bootstrap/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="libs/bootstrap-icons/bootstrap-icons.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="/images/icon-192.png" type="image/png">
</head>
<body>
    <!-- Contenedor para Notificaciones -->
    <div id="notification-container"></div>

    <!-- Loading Spinner -->
    <div id="loading-overlay" class="d-none">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
    </div>

    <main class="container py-4">
        <header class="text-center mb-4">
            <h1 class="display-4"><i class="bi bi-cart-check-fill icon-titulo"></i> Compr-As</h1>
            <p class="lead">Tu lista de compras inteligente</p>
        </header>

        <!-- Formulario para Añadir Productos -->
        <section class="card mb-4">
            <form class="card-body">
                <h5 class="card-title">Añadir Producto</h5>
                
                <div class="row g-2">
                    <!-- Columna Izquierda -->
                    <div class="col-md-7">
                        <div class="mb-2">
                            <label for="nombre-producto" class="form-label">Producto</label>
                            <div class="input-group">
                                <input type="text" id="nombre-producto" class="form-control" placeholder="Nombre" list="sugerencias-productos">
                                <datalist id="sugerencias-productos"></datalist>
                                <button class="btn btn-outline-secondary" type="button" id="btn-voz"><i class="bi bi-mic-fill icon-microfono"></i></button>
                            </div>
                        </div>

                        <div class="row g-2">
                            <div class="col-sm-6 mb-2">
                                <label for="cantidad-producto" class="form-label">Cantidad</label>
                                <div class="input-group">
                                    <input type="number" id="cantidad-producto" class="form-control" placeholder="1" min="1">
                                    <select id="unidad-producto" class="form-select flex-grow-0" style="width: 70px;">
                                        <option value="ud">Ud</option>
                                        <option value="kg">kg</option>
                                        <option value="g">g</option>
                                        <option value="l">l</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-sm-6 mb-2">
                                <label for="precio-producto" class="form-label">Precio</label>
                                <div class="input-group">
                                    <input type="number" id="precio-producto" class="form-control" placeholder="0.00" min="0" step="1">
                                    <span class="input-group-text" id="precio-unidad-label">€/ud</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Columna Derecha -->
                    <div class="col-md-5">
                        <div class="mb-2">
                            <label for="categoria-producto" class="form-label">Categoría</label>
                            <select id="categoria-producto" class="form-select" aria-label="Categoría">
                                <option selected disabled value="">Seleccionar categoría...</option>
                            </select>
                        </div>
                        <div class="row g-2">
                            <div class="col-sm-6 mb-2">
                                <label for="prioridad-producto" class="form-label">Prioridad</label>
                                <select id="prioridad-producto" class="form-select" aria-label="Prioridad">
                                    <option value="baja" selected>Baja</option>
                                    <option value="media">Media</option>
                                    <option value="alta">Alta</option>
                                </select>
                            </div>
                            <div class="col-sm-6 mb-2">
                                <label for="tienda-producto" class="form-label">Tienda</label>
                                <select id="tienda-producto" class="form-select" aria-label="Tienda">
                                    <option selected disabled value="">Elige</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Fila de Notas y Botón -->
                <div class="row g-2 align-items-end">
                    <div class="col-md-7">
                        <label for="notas-producto" class="form-label">Notas</label>
                        <textarea id="notas-producto" class="form-control" rows="1" placeholder="Detalles, marca, ofertas..."></textarea>
                    </div>
                    <div class="col-md-5">
                        <button id="btn-anadir" class="btn btn-primary w-100">Añadir a la lista</button>
                    </div>
                </div>
            </form>
        </section>

        <!-- Controles y Búsqueda -->
        <section class="card mb-4">
            <div class="card-body">
                <div class="row g-2">
                    <!-- Columna de Búsqueda (Izquierda-Arriba en móvil) -->
                    <div class="col-7 col-lg-auto order-1">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" id="busqueda" class="form-control" placeholder="Producto">
                        </div>
                    </div>

                    <!-- Columna de Tienda (Izquierda-Abajo en móvil) -->
                    <div class="col-7 col-lg-auto order-3 order-lg-2">
                        <div class="input-group">
                            <label class="input-group-text" for="filtro-tienda"><i class="bi bi-shop"></i></label>
                            <select class="form-select" id="filtro-tienda">
                                <option value="all" selected>Tienda</option>
                            </select>
                        </div>
                    </div>

                    <!-- Columna de Prioridad (Derecha-Arriba en móvil) -->
                    <div class="col-5 col-lg-auto order-2 order-lg-3">
                        <div class="input-group">
                            <label class="input-group-text" for="filtro-prioridad"><i class="bi bi-exclamation-diamond"></i></label>
                            <select class="form-select" id="filtro-prioridad">
                                <option value="all" selected>Prioridad</option>
                                <option value="alta">Alta</option>
                                <option value="media">Media</option>
                                <option value="baja">Baja</option>
                            </select>
                        </div>
                    </div>

                    <!-- Columna de Botones (Derecha-Abajo en móvil) -->
                    <div class="col-5 col-lg-auto order-4 ms-lg-auto">
                        <div class="btn-group w-100" role="group" id="contenedor-botones-principal">
                            <!-- Botón 1: Borrar Vista Actual -->
                            <button type="button" class="btn btn-outline-secondary" id="btn-borrar-vista" title="Borrar productos de la vista actual">
                                <i class="bi bi-trash"></i>
                            </button>

                            <!-- Botón 2: Ordenar -->
                            <button id="btn-ordenar" class="btn btn-outline-secondary" title="Ordenar">
                                <i class="bi bi-sort-alpha-down"></i>
                            </button>
                            
                            <!-- Botón 3: Más Opciones (con Dropdown) -->
                            <div class="btn-group" role="group">
                                <button id="btn-mas-opciones" type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" title="Más opciones">
                                    <i class="bi bi-gear-fill"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="#" id="menu-ocultar-comprados">Ocultar/Mostrar comprados</a></li>
                                    <li><a class="dropdown-item" href="#" id="menu-borrar-comprados">Borrar comprados</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" id="menu-import-export">Importar / Exportar...</a></li>
                                    <li><a class="dropdown-item" href="#" id="menu-gestionar">Gestionar...</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#" id="menu-borrar-todo">Borrar TODA la lista</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Barra de Filtros Activos -->
        <section id="active-filters-bar" class="d-flex align-items-center alert alert-light py-2 px-3 mb-4 d-none">
            <span class="text-muted small">Mostrando resultados filtrados.</span>
            <button id="btn-limpiar-filtros" class="btn btn-sm btn-secondary ms-3">Limpiar filtros</button>
        </section>

        <!-- Lista de Compras -->
        <section id="lista-compras" class="mb-4" aria-live="polite">
            <!-- Los productos se insertarán aquí dinámicamente -->
        </section>

        <!-- Total -->
        <section class="d-flex justify-content-end">
            <div class="p-3 mt-4 border border-primary rounded">
                <p class="fs-5 mb-1 text-end">Total de productos: <span id="total-productos" class="fw-bold">0</span></p>
                <p class="fs-5 mb-0 text-end">Coste total: <span id="coste-total" class="fw-bold">0.00</span> €</p>
            </div>
        </section>
    </main>

    <!-- ------------- MODALES ------------- -->

    <!-- Modal para Gestión -->
    <div class="modal fade" id="gestionModal" tabindex="-1" aria-labelledby="gestionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="gestionModalLabel">Gestionar Opciones</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Pestañas de Navegación -->
                    <ul class="nav nav-tabs" id="gestionTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="opciones-tab" data-bs-toggle="tab" data-bs-target="#opciones-pane" type="button" role="tab">Opciones</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="categorias-tab" data-bs-toggle="tab" data-bs-target="#categorias-pane" type="button" role="tab">Categorías</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tiendas-tab" data-bs-toggle="tab" data-bs-target="#tiendas-pane" type="button" role="tab">Tiendas</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="autocompletado-tab" data-bs-toggle="tab" data-bs-target="#autocompletado-pane" type="button" role="tab">Autocompletado</button>
                        </li>
                    </ul>
                    <!-- Contenido de las Pestañas -->
                    <div class="tab-content" id="gestionTabContent">
                        <!-- Panel de Opciones -->
                        <div class="tab-pane fade show active p-3" id="opciones-pane" role="tabpanel">
                            <h6>Opciones Generales</h6>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" role="switch" id="checkAutocompletado" checked>
                                <label class="form-check-label" for="checkAutocompletado">Habilitar autocompletado de productos</label>
                            </div>
                            <hr>
                            <h6>Ajustes de Visualización</h6>
                            <div>
                                <label for="rangoTamanoLetra" class="form-label">Tamaño del Texto</label>
                                <input type="range" class="form-range" min="12" max="24" id="rangoTamanoLetra">
                            </div>
                        </div>
                        <!-- Panel de Autocompletado -->
                        <div class="tab-pane fade p-3" id="autocompletado-pane" role="tabpanel">
                            <div class="input-group mb-3">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" id="filtro-autocompletado" class="form-control" placeholder="Buscar producto en autocompletado...">
                            </div>
                            <p class="text-muted">Aquí puedes ver los productos que has añadido manualmente a la lista de autocompletado. Puedes eliminarlos si ya no los necesitas.</p>
                            <ul id="lista-autocompletado-gestion" class="list-group"></ul>
                        </div>
                        <!-- Panel de Categorías -->
                        <div class="tab-pane fade p-3" id="categorias-pane" role="tabpanel">
                            <div class="input-group mb-3">
                                <input type="text" id="nueva-categoria" class="form-control" placeholder="Nueva categoría">
                                <button id="btn-anadir-categoria" class="btn btn-outline-primary">Añadir</button>
                            </div>
                            <ul id="lista-categorias" class="list-group"></ul>
                        </div>
                        <!-- Panel de Tiendas -->
                        <div class="tab-pane fade p-3" id="tiendas-pane" role="tabpanel">
                            <div class="input-group mb-3">
                                <input type="text" id="nueva-tienda" class="form-control" placeholder="Nueva tienda">
                                <button id="btn-anadir-tienda" class="btn btn-outline-primary">Añadir</button>
                            </div>
                            <ul id="lista-tiendas" class="list-group"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para Selección de Exportación -->
    <div class="modal fade" id="exportSelectionModal" tabindex="-1" aria-labelledby="exportSelectionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exportSelectionModalLabel">Seleccionar productos a exportar</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="export-selection-body">
                    <!-- El contenido se generará dinámicamente -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btn-confirmar-exportacion">Confirmar y Exportar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Previsualización de Importación -->
    <div class="modal fade" id="importPreviewModal" tabindex="-1" aria-labelledby="importPreviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="importPreviewModalLabel">Previsualización de Importación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="import-preview-body">
                    <!-- El contenido se generará dinámicamente -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btn-confirmar-importacion">Confirmar Importación</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Resultados de Importación -->
    <div class="modal fade" id="importResultModal" tabindex="-1" aria-labelledby="importResultModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="importResultModalLabel">Resultado de la Importación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="import-result-body">
                    <!-- El contenido se generará dinámicamente -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Aceptar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Producto -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editModalLabel">Editar Producto</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="edit-producto-id">
            <!-- Contenido del formulario de edición, se rellenará con JS -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary" id="btn-guardar-edicion">Guardar Cambios</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para Edición de Nombres (Categorías/Tiendas) -->
    <div class="modal fade" id="editNameModal" tabindex="-1" aria-labelledby="editNameModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editNameModalLabel">Editar Nombre</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="edit-name-id">
            <input type="hidden" id="edit-name-type">
            <div class="mb-3">
              <label for="edit-name-input" class="form-label">Nombre</label>
              <input type="text" id="edit-name-input" class="form-control">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary" id="btn-save-name">Guardar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para Guía de Importación -->
    <div class="modal fade" id="importHelpModal" tabindex="-1" aria-labelledby="importHelpModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="importHelpModalLabel">Guía de Formato de Importación (.txt)</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Para importar una lista desde un archivo <code>.txt</code>, cada línea del archivo debe representar un producto y seguir el formato especificado.</p>
            <p>El sistema es flexible, pero aquí está la estructura completa y recomendada por línea:</p>
            
            <pre class="bg-light p-3 rounded"><code>[s] Nombre (c u) @ Tienda - p€ (Prioridad: a) (Nota: n)</code></pre>
            
            <h6>Componentes:</h6>
            <ul>
                <li><code>[s]</code>: Estado. Usa <code>[x]</code> para "comprado" o <code>[ ]</code> para "no comprado". <strong>(Obligatorio)</strong></li>
                <li><code>Nombre</code>: El nombre del producto. <strong>(Obligatorio)</strong></li>
                <li><code>(c u)</code>: Cantidad y unidad. Ej: <code>(1.5 kg)</code>, <code>(6 ud)</code>. <em>(Opcional)</em></li>
                <li><code>@ Tienda</code>: Nombre de la tienda. Ej: <code>@ Mercadona</code>. <em>(Opcional)</em></li>
                <li><code>- p€</code>: Precio total del producto. Ej: <code>- 5.99€</code>. <em>(Opcional)</em></li>
                <li><code>(Prioridad: a)</code>: Nivel de prioridad. "a" puede ser <code>alta</code>, <code>media</code>, o <code>baja</code>. <em>(Opcional)</em></li>
                <li><code>(Nota: n)</code>: Notas adicionales. Ej: <code>(Nota: que sea sin lactosa)</code>. <em>(Opcional)</em></li>
            </ul>
    
            <h6>Ejemplos Válidos:</h6>
            <pre class="bg-light p-3 rounded"><code>[ ] Leche (6 l) @ Carrefour - 5.50€ (Prioridad: alta) (Nota: la de siempre)
[x] Pan de molde (1 ud)
[ ] Manzanas (2.5 kg) - 4.95€
[ ] Papel de cocina</code></pre>
            <p class="mt-3"><strong>Nota:</strong> El orden de los componentes opcionales no importa, pero se recomienda seguir la estructura para mayor claridad.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para Confirmación Genérica -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="confirmModalLabel">Confirmar Acción</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="confirmModalBody">
            ¿Estás seguro?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="confirmModalCancel">Cancelar</button>
            <button type="button" class="btn btn-primary" id="confirmModalOk">Aceptar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para Importar/Exportar -->
    <div class="modal fade" id="exportImportModal" tabindex="-1" aria-labelledby="exportImportModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exportImportModalLabel">Opciones de Importación y Exportación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="list-group">
                        <a href="#" id="btn-export-txt" class="list-group-item list-group-item-action" role="button">Exportar a .txt</a>
                        <a href="#" id="btn-export-jpg" class="list-group-item list-group-item-action" role="button">Exportar a .jpg</a>
                        <a href="#" id="btn-export-pdf" class="list-group-item list-group-item-action" role="button">Exportar a .pdf</a>
                        <label for="btn-import-txt" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" style="cursor: pointer;">Importar desde .txt <i class="bi bi-info-circle ms-auto" id="btn-ayuda-importar" style="cursor: pointer;" title="Ayuda sobre el formato de importación" role="button" tabindex="0"></i></label>
                        <input type="file" id="btn-import-txt" class="d-none" accept=".txt">
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script src="libs/bootstrap/bootstrap.bundle.min.js"></script>
    <script src="libs/jspdf/jspdf.umd.min.js"></script>
    <script src="libs/html2canvas/html2canvas.min.js"></script>
    <script type="module" src="app.js"></script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registrado con éxito:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Fallo en el registro de ServiceWorker:', error);
                    });
            });
        }
    </script>
</body>
</html>